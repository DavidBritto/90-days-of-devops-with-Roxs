name: Deploy con Docker Compose

on:
  push:
    branches: [ main ] # Se dispara al hacer push a main
  workflow_dispatch:   # Permite dispararlo manualmente

jobs:
  deploy:
    # Â¡Clave! Le decimos que use nuestro runner auto-alojado
    runs-on: self-hosted

    steps:
    - name: ðŸ“¥ Clonar el cÃ³digo en el runner
      uses: actions/checkout@v4

    - name: ðŸ›‘ Parar servicios anteriores (si existen)
      # El '|| true' evita que el workflow falle si no hay nada que parar
      run: docker compose -f mi-app/docker-compose.yml down -v || true

    - name: ðŸ“¦ Construir nuevas imÃ¡genes
      run: docker compose -f mi-app/docker-compose.yml build

    - name: ðŸš€ Levantar los servicios en modo detached (-d)
      run: docker compose -f mi-app/docker-compose.yml up -d

    - name: ðŸ©º Verificar que la app responde
      # Damos unos segundos para que el servidor inicie
      run: |
        sleep 5
        curl -f http://localhost:3000
